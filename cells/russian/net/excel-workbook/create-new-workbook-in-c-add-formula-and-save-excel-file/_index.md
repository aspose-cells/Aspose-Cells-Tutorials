---
category: general
date: 2026-02-23
description: Создайте новую книгу программно на C# и добавьте формулу в ячейку. Узнайте,
  как использовать EXPAND, а затем легко сохраните книгу Excel.
draft: false
keywords:
- create new workbook
- add formula to cell
- save excel workbook
- how to use expand
- create excel file programmatically
language: ru
og_description: Создайте новую книгу Excel программно на C#. Добавьте формулу в ячейку,
  узнайте, как использовать функцию EXPAND, и сохраните книгу Excel за секунды.
og_title: Создать новую книгу в C# – добавить формулу и сохранить файл Excel
tags:
- C#
- Excel Automation
- Aspose.Cells
title: Создать новую рабочую книгу в C# – добавить формулу и сохранить файл Excel
url: /ru/net/excel-workbook/create-new-workbook-in-c-add-formula-and-save-excel-file/
---

{{< blocks/products/pf/main-wrap-class >}}
{{< blocks/products/pf/main-container >}}
{{< blocks/products/pf/tutorial-page-section >}}

# Создание новой книги Excel в C# – Добавление формулы и сохранение файла

Задумывались ли вы когда‑нибудь, как **создать новые объекты workbook** из кода, не открывая Excel? Вы не одиноки. Многие разработчики сталкиваются с проблемой, когда нужно «на лету» сгенерировать таблицу — возможно, для отчёта, экспорта или быстрой выгрузки данных.  

Хорошая новость? В этом руководстве вы увидите, как **создать новую книгу**, добавить **формулу в ячейку**, а затем **сохранить Excel‑книгу** всего несколькими строками C#. Мы также разберём, **как использовать EXPAND**, чтобы генерировать динамические массивы без ручного копирования. К концу вы сможете **программно создавать Excel‑файл** и передавать его пользователям или downstream‑сервисам.

## Предварительные требования

- .NET 6.0 или новее (подойдёт любой современный .NET‑runtime)
- Aspose.Cells for .NET (бесплатная trial‑версия или лицензия) — эта библиотека предоставляет классы `Workbook` и `Worksheet`, используемые ниже.
- Базовое понимание синтаксиса C# — глубоких знаний Excel не требуется.

Если всё уже есть, отлично! Если нет, возьмите Aspose.Cells из NuGet (`Install-Package Aspose.Cells`) и вы будете готовы к работе.

---

## Шаг 1: Создание новой книги — фундамент

Для начала нам нужно создать новый объект workbook. Представьте, что вы открываете совершенно новый пустой файл Excel.

```csharp
using Aspose.Cells;

public class ExcelGenerator
{
    public void Generate()
    {
        // Step 1: Create a new workbook (this is the core of create new workbook)
        Workbook workbook = new Workbook();
```

> **Почему это важно:** Класс `Workbook` — точка входа для любой работы с Excel. Создавая новый экземпляр, мы выделяем память под листы, стили и формулы — и всё это без обращения к файловой системе.

---

## Шаг 2: Доступ к первому листу

Каждая новая книга содержит лист по умолчанию (с именем *Sheet1*). Мы получим его, чтобы разместить данные и формулы.

```csharp
        // Step 2: Access the first worksheet
        Worksheet worksheet = workbook.Worksheets[0];
```

> **Совет:** Если нужны дополнительные листы, просто вызовите `workbook.Worksheets.Add("MySheet")` и работайте с возвращённым объектом `Worksheet`.

---

## Шаг 3: Добавление формулы в ячейку — использование EXPAND

А теперь самое интересное: вставка формулы. Функция `EXPAND` идеальна, когда нужно превратить статический массив в более крупный автоматически заполняемый диапазон.

```csharp
        // Step 3: Add formula to cell A1 using EXPAND
        // This creates a 5‑row array from the constant {1,2,3}
        worksheet.Cells["A1"].Formula = "EXPAND({1,2,3},5,1)";
```

### Как работает формула EXPAND

| Аргумент | Значение |
|----------|----------|
| `{1,2,3}` | Исходный массив (горизонтальный список из трёх чисел) |
| `5`       | Требуемое количество строк в результате |
| `1`       | Требуемое количество столбцов (оставьте 1, чтобы получить вертикальный массив) |

При вычислении Excel выдаёт **вертикальный** список:

```
A1: 1
A2: 2
A3: 3
A4: 0   (filled with zeros)
A5: 0
```

> **Зачем использовать EXPAND?** Она устраняет необходимость ручного копирования или VBA‑циклов. Функция динамически пере‑форматирует данные, делая таблицы более надёжными и простыми в обслуживании.

---

## Шаг 4: Сохранение Excel‑книги — запись результата

После того как формула добавлена, последний шаг — записать книгу на диск. Вы можете выбрать любую папку, в которую у вас есть права записи.

```csharp
        // Step 4: Save the workbook to view the result
        string outputPath = @"C:\Temp\ExpandFormula.xlsx";
        workbook.Save(outputPath);
    }
}
```

> **Что вы увидите:** Откройте `ExpandFormula.xlsx` в Excel, и в ячейке `A1` отобразится расширенный массив. Формула остаётся в ячейке, поэтому при изменении исходного массива результат обновится автоматически.

---

## Необязательно: Программная проверка результата

Если не хочется открывать Excel вручную, можно считать значения обратно и убедиться, что они соответствуют ожиданиям.

```csharp
        // Verify values without opening Excel
        for (int row = 0; row < 5; row++)
        {
            var value = worksheet.Cells[row, 0].Value; // column 0 = A
            Console.WriteLine($"Row {row + 1}: {value}");
        }
```

Выполнение кода выведет:

```
Row 1: 1
Row 2: 2
Row 3: 3
Row 4: 0
Row 5: 0
```

---

## Часто задаваемые вопросы и особые случаи

| Вопрос | Ответ |
|--------|-------|
| **Можно ли использовать EXPAND с более крупным исходным массивом?** | Конечно. Просто замените `{1,2,3}` любой константой или диапазоном ячеек, например `EXPAND(A1:C1,10,1)`. |
| **А как получить горизонтальный результат?** | Поменяйте местами аргументы строк/столбцов: `EXPAND({1,2,3},1,5)` даст 1‑строку и 5‑столбцов. |
| **Будет ли работать в более старых версиях Excel?** | `EXPAND` доступна, начиная с Excel 365/2021. Для более старых версий придётся имитировать массив с помощью `INDEX`/`SEQUENCE`. |
| **Нужно ли вызывать `workbook.CalculateFormula()`?** | Нет. Aspose.Cells автоматически вычисляет формулы при сохранении, поэтому значения появляются сразу. |
| **Как добавить несколько листов перед сохранением?** | Вызовите `workbook.Worksheets.Add("SecondSheet")` и повторите операции над ячейками на новом листе. |

---

## Полный рабочий пример

Ниже представлен полностью готовый к запуску код. Скопируйте‑вставьте его в консольное приложение, укажите путь вывода и нажмите **F5**.

```csharp
using System;
using Aspose.Cells;

namespace ExcelAutomationDemo
{
    class Program
    {
        static void Main(string[] args)
        {
            // Create new workbook
            Workbook workbook = new Workbook();

            // Access first worksheet
            Worksheet worksheet = workbook.Worksheets[0];

            // Add EXPAND formula to A1
            worksheet.Cells["A1"].Formula = "EXPAND({1,2,3},5,1)";

            // Optional: verify values in console
            workbook.CalculateFormula(); // ensures formulas are evaluated now
            for (int i = 0; i < 5; i++)
            {
                Console.WriteLine($"A{i + 1} = {worksheet.Cells[i, 0].Value}");
            }

            // Save the workbook
            string filePath = @"C:\Temp\ExpandFormula.xlsx";
            workbook.Save(filePath);
            Console.WriteLine($"Workbook saved to {filePath}");
        }
    }
}
```

**Ожидаемый вывод в консоли:**

```
A1 = 1
A2 = 2
A3 = 3
A4 = 0
A5 = 0
Workbook saved to C:\Temp\ExpandFormula.xlsx
```

Откройте сгенерированный файл — в колонке **A** вы увидите те же числа.

---

## Визуальное резюме

![Создание новой книги Excel пример](create-new-workbook.png "Скриншот, показывающий новую книгу, созданную с помощью create new workbook in C#")

*Изображение демонстрирует только что созданную книгу с результатом функции EXPAND.*

---

## Заключение

Теперь вы знаете, как **создать новую книгу**, **добавить формулу в ячейку** и **сохранить Excel‑книгу** с помощью C#. Освоив **использование EXPAND**, вы сможете генерировать динамические массивы без ручных усилий, а весь процесс позволяет **программно создавать Excel‑файл** для любой автоматизации.

Что дальше? Попробуйте заменить константный массив ссылкой на диапазон, поэкспериментируйте с различными размерами `EXPAND`, либо соедините несколько формул на разных листах. Та же схема работает и для диаграмм, стилей, и даже сводных таблиц — так что исследуйте дальше.

Если возникли трудности, оставляйте комментарий ниже. Приятного кодинга и наслаждайтесь мощью программного Excel!

{{< /blocks/products/pf/tutorial-page-section >}}
{{< /blocks/products/pf/main-container >}}
{{< /blocks/products/pf/main-wrap-class >}}
{{< blocks/products/products-backtop-button >}}